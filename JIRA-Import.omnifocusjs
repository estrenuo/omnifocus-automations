/*{
    "type": "action",
    "targets": ["omnifocus"],
    "author": "OmniFocus Automation",
    "identifier": "com.omnifocus.jira-import",
    "version": "1.9.0",
    "description": "Imports all open JIRA issues as OmniFocus tasks with proper field mapping",
    "label": "Import JIRA Issues",
    "shortLabel": "JIRA Import",
    "paletteLabel": "Import Open JIRA Issues",
    "image": "square.and.arrow.down"
}*/
(() => {
    // Credentials for storing JIRA credentials
    const credentials = new Credentials();

    // === Localization ===
    const STRINGS = {
        en: {
            continueButton: "Continue",
            cancelButton: "Cancel",
            credentialsPrompt: "Enter your JIRA credentials (will be stored securely)",
            domainLabel: "JIRA Domain/URL",
            domainPlaceholder: "your-company.atlassian.net or https://jira.yourcompany.com",
            authTypeLabel: "Authentication Type",
            authCloud: "Cloud (Email + API Token)",
            authServer: "Server/DC (Personal Access Token)",
            emailLabel: "Email (Cloud only)",
            apiTokenLabel: "API Token / Personal Access Token",
            projectKeyLabel: "Project Key (optional)",
            projectKeyPlaceholder: "Leave empty to import from all projects",
            domainTokenRequired: "Domain and API token are required",
            emailRequired: "Email is required for Cloud authentication",
            credentialsFoundTitle: "JIRA Credentials Found",
            credentialsFoundMsg: "Stored credentials found for:\nDomain: {domain}\nEmail: {email}\n\nWhat would you like to do?",
            useStored: "Use Stored Credentials",
            clearReenter: "Clear & Re-enter Credentials",
            reenterDomainLabel: "JIRA Domain",
            reenterEmailLabel: "JIRA Email",
            reenterTokenLabel: "JIRA API Token",
            allFieldsRequired: "Domain, email, and API token are required",
            importingTitle: "Importing JIRA Issues",
            importingMsg: "Fetching issues from JIRA...",
            noIssuesTitle: "No Issues Found",
            noIssuesMsg: "No open JIRA issues found matching the criteria.",
            summaryTitle: "JIRA Import",
            summaryComplete: "JIRA Import Complete",
            summaryTotal: "Total issues found",
            summaryCreated: "New tasks created",
            summarySkipped: "Skipped (already imported)",
            summaryLocation: 'Tasks have been added to the "JIRA Issues" project in the "JIRA" folder.',
            errorTitle: "Error",
            noteIssue: "JIRA ISSUE",
            noteLink: "Link",
            noteStatus: "Status",
            noteType: "Type",
            notePriority: "Priority",
            noteAssignee: "Assignee",
            noteReporter: "Reporter",
            noteLabels: "Labels",
            noteComponents: "Components",
            noteCreated: "Created",
            noteUpdated: "Updated",
            noteDescription: "DESCRIPTION"
        },
        es: {
            continueButton: "Continuar",
            cancelButton: "Cancelar",
            credentialsPrompt: "Ingresa tus credenciales de JIRA (se almacenarÃ¡n de forma segura)",
            domainLabel: "Dominio/URL de JIRA",
            domainPlaceholder: "tu-empresa.atlassian.net o https://jira.tuempresa.com",
            authTypeLabel: "Tipo de autenticaciÃ³n",
            authCloud: "Cloud (Email + Token API)",
            authServer: "Server/DC (Token de acceso personal)",
            emailLabel: "Email (solo Cloud)",
            apiTokenLabel: "Token API / Token de acceso personal",
            projectKeyLabel: "Clave de proyecto (opcional)",
            projectKeyPlaceholder: "Dejar vacÃ­o para importar de todos los proyectos",
            domainTokenRequired: "El dominio y el token API son obligatorios",
            emailRequired: "El email es obligatorio para autenticaciÃ³n Cloud",
            credentialsFoundTitle: "Credenciales JIRA encontradas",
            credentialsFoundMsg: "Credenciales almacenadas para:\nDominio: {domain}\nEmail: {email}\n\nÂ¿QuÃ© deseas hacer?",
            useStored: "Usar credenciales guardadas",
            clearReenter: "Borrar y volver a ingresar",
            reenterDomainLabel: "Dominio JIRA",
            reenterEmailLabel: "Email JIRA",
            reenterTokenLabel: "Token API JIRA",
            allFieldsRequired: "Dominio, email y token API son obligatorios",
            importingTitle: "Importando issues de JIRA",
            importingMsg: "Obteniendo issues de JIRA...",
            noIssuesTitle: "Sin issues",
            noIssuesMsg: "No se encontraron issues JIRA abiertos que coincidan con los criterios.",
            summaryTitle: "ImportaciÃ³n JIRA",
            summaryComplete: "ImportaciÃ³n JIRA completada",
            summaryTotal: "Total de issues encontrados",
            summaryCreated: "Nuevas tareas creadas",
            summarySkipped: "Omitidos (ya importados)",
            summaryLocation: 'Las tareas se han aÃ±adido al proyecto "JIRA Issues" en la carpeta "JIRA".',
            errorTitle: "Error",
            noteIssue: "ISSUE JIRA",
            noteLink: "Enlace",
            noteStatus: "Estado",
            noteType: "Tipo",
            notePriority: "Prioridad",
            noteAssignee: "Asignado",
            noteReporter: "Reportado por",
            noteLabels: "Etiquetas",
            noteComponents: "Componentes",
            noteCreated: "Creado",
            noteUpdated: "Actualizado",
            noteDescription: "DESCRIPCIÃ“N"
        },
        fr: {
            continueButton: "Continuer",
            cancelButton: "Annuler",
            credentialsPrompt: "Entrez vos identifiants JIRA (seront stockÃ©s de maniÃ¨re sÃ©curisÃ©e)",
            domainLabel: "Domaine/URL JIRA",
            domainPlaceholder: "votre-entreprise.atlassian.net ou https://jira.votreentreprise.com",
            authTypeLabel: "Type d'authentification",
            authCloud: "Cloud (Email + Jeton API)",
            authServer: "Server/DC (Jeton d'accÃ¨s personnel)",
            emailLabel: "Email (Cloud uniquement)",
            apiTokenLabel: "Jeton API / Jeton d'accÃ¨s personnel",
            projectKeyLabel: "ClÃ© de projet (optionnel)",
            projectKeyPlaceholder: "Laisser vide pour importer de tous les projets",
            domainTokenRequired: "Le domaine et le jeton API sont requis",
            emailRequired: "L'email est requis pour l'authentification Cloud",
            credentialsFoundTitle: "Identifiants JIRA trouvÃ©s",
            credentialsFoundMsg: "Identifiants stockÃ©s pour :\nDomaine : {domain}\nEmail : {email}\n\nQue souhaitez-vous faire ?",
            useStored: "Utiliser les identifiants stockÃ©s",
            clearReenter: "Effacer et ressaisir",
            reenterDomainLabel: "Domaine JIRA",
            reenterEmailLabel: "Email JIRA",
            reenterTokenLabel: "Jeton API JIRA",
            allFieldsRequired: "Domaine, email et jeton API sont requis",
            importingTitle: "Importation des tickets JIRA",
            importingMsg: "RÃ©cupÃ©ration des tickets depuis JIRA...",
            noIssuesTitle: "Aucun ticket trouvÃ©",
            noIssuesMsg: "Aucun ticket JIRA ouvert ne correspond aux critÃ¨res.",
            summaryTitle: "Importation JIRA",
            summaryComplete: "Importation JIRA terminÃ©e",
            summaryTotal: "Total de tickets trouvÃ©s",
            summaryCreated: "Nouvelles tÃ¢ches crÃ©Ã©es",
            summarySkipped: "IgnorÃ©s (dÃ©jÃ  importÃ©s)",
            summaryLocation: 'Les tÃ¢ches ont Ã©tÃ© ajoutÃ©es au projet "JIRA Issues" dans le dossier "JIRA".',
            errorTitle: "Erreur",
            noteIssue: "TICKET JIRA",
            noteLink: "Lien",
            noteStatus: "Statut",
            noteType: "Type",
            notePriority: "PrioritÃ©",
            noteAssignee: "AssignÃ© Ã ",
            noteReporter: "Rapporteur",
            noteLabels: "LibellÃ©s",
            noteComponents: "Composants",
            noteCreated: "CrÃ©Ã©",
            noteUpdated: "Mis Ã  jour",
            noteDescription: "DESCRIPTION"
        },
        de: {
            continueButton: "Weiter",
            cancelButton: "Abbrechen",
            credentialsPrompt: "Geben Sie Ihre JIRA-Zugangsdaten ein (werden sicher gespeichert)",
            domainLabel: "JIRA-Domain/URL",
            domainPlaceholder: "ihre-firma.atlassian.net oder https://jira.ihrefirma.com",
            authTypeLabel: "Authentifizierungstyp",
            authCloud: "Cloud (Email + API-Token)",
            authServer: "Server/DC (PersÃ¶nlicher Zugriffstoken)",
            emailLabel: "Email (nur Cloud)",
            apiTokenLabel: "API-Token / PersÃ¶nlicher Zugriffstoken",
            projectKeyLabel: "ProjektschlÃ¼ssel (optional)",
            projectKeyPlaceholder: "Leer lassen, um aus allen Projekten zu importieren",
            domainTokenRequired: "Domain und API-Token sind erforderlich",
            emailRequired: "Email ist fÃ¼r Cloud-Authentifizierung erforderlich",
            credentialsFoundTitle: "JIRA-Zugangsdaten gefunden",
            credentialsFoundMsg: "Gespeicherte Zugangsdaten fÃ¼r:\nDomain: {domain}\nEmail: {email}\n\nWas mÃ¶chten Sie tun?",
            useStored: "Gespeicherte Zugangsdaten verwenden",
            clearReenter: "LÃ¶schen und neu eingeben",
            reenterDomainLabel: "JIRA-Domain",
            reenterEmailLabel: "JIRA-Email",
            reenterTokenLabel: "JIRA API-Token",
            allFieldsRequired: "Domain, Email und API-Token sind erforderlich",
            importingTitle: "JIRA-VorgÃ¤nge importieren",
            importingMsg: "VorgÃ¤nge von JIRA abrufen...",
            noIssuesTitle: "Keine VorgÃ¤nge gefunden",
            noIssuesMsg: "Keine offenen JIRA-VorgÃ¤nge gefunden, die den Kriterien entsprechen.",
            summaryTitle: "JIRA-Import",
            summaryComplete: "JIRA-Import abgeschlossen",
            summaryTotal: "Gefundene VorgÃ¤nge gesamt",
            summaryCreated: "Neue Aufgaben erstellt",
            summarySkipped: "Ãœbersprungen (bereits importiert)",
            summaryLocation: 'Aufgaben wurden dem Projekt "JIRA Issues" im Ordner "JIRA" hinzugefÃ¼gt.',
            errorTitle: "Fehler",
            noteIssue: "JIRA-VORGANG",
            noteLink: "Link",
            noteStatus: "Status",
            noteType: "Typ",
            notePriority: "PrioritÃ¤t",
            noteAssignee: "Bearbeiter",
            noteReporter: "Ersteller",
            noteLabels: "Labels",
            noteComponents: "Komponenten",
            noteCreated: "Erstellt",
            noteUpdated: "Aktualisiert",
            noteDescription: "BESCHREIBUNG"
        },
        it: {
            continueButton: "Continua",
            cancelButton: "Annulla",
            credentialsPrompt: "Inserisci le tue credenziali JIRA (verranno memorizzate in modo sicuro)",
            domainLabel: "Dominio/URL JIRA",
            domainPlaceholder: "tua-azienda.atlassian.net o https://jira.tuaazienda.com",
            authTypeLabel: "Tipo di autenticazione",
            authCloud: "Cloud (Email + Token API)",
            authServer: "Server/DC (Token di accesso personale)",
            emailLabel: "Email (solo Cloud)",
            apiTokenLabel: "Token API / Token di accesso personale",
            projectKeyLabel: "Chiave progetto (opzionale)",
            projectKeyPlaceholder: "Lasciare vuoto per importare da tutti i progetti",
            domainTokenRequired: "Dominio e token API sono obbligatori",
            emailRequired: "L'email Ã¨ obbligatoria per l'autenticazione Cloud",
            credentialsFoundTitle: "Credenziali JIRA trovate",
            credentialsFoundMsg: "Credenziali memorizzate per:\nDominio: {domain}\nEmail: {email}\n\nCosa vuoi fare?",
            useStored: "Usa credenziali memorizzate",
            clearReenter: "Cancella e reinserisci",
            reenterDomainLabel: "Dominio JIRA",
            reenterEmailLabel: "Email JIRA",
            reenterTokenLabel: "Token API JIRA",
            allFieldsRequired: "Dominio, email e token API sono obbligatori",
            importingTitle: "Importazione ticket JIRA",
            importingMsg: "Recupero ticket da JIRA...",
            noIssuesTitle: "Nessun ticket trovato",
            noIssuesMsg: "Nessun ticket JIRA aperto corrisponde ai criteri.",
            summaryTitle: "Importazione JIRA",
            summaryComplete: "Importazione JIRA completata",
            summaryTotal: "Ticket totali trovati",
            summaryCreated: "Nuove attivitÃ  create",
            summarySkipped: "Ignorati (giÃ  importati)",
            summaryLocation: 'Le attivitÃ  sono state aggiunte al progetto "JIRA Issues" nella cartella "JIRA".',
            errorTitle: "Errore",
            noteIssue: "TICKET JIRA",
            noteLink: "Link",
            noteStatus: "Stato",
            noteType: "Tipo",
            notePriority: "PrioritÃ ",
            noteAssignee: "Assegnato a",
            noteReporter: "Segnalato da",
            noteLabels: "Etichette",
            noteComponents: "Componenti",
            noteCreated: "Creato",
            noteUpdated: "Aggiornato",
            noteDescription: "DESCRIZIONE"
        },
        pt: {
            continueButton: "Continuar",
            cancelButton: "Cancelar",
            credentialsPrompt: "Insira suas credenciais JIRA (serÃ£o armazenadas com seguranÃ§a)",
            domainLabel: "DomÃ­nio/URL JIRA",
            domainPlaceholder: "sua-empresa.atlassian.net ou https://jira.suaempresa.com",
            authTypeLabel: "Tipo de autenticaÃ§Ã£o",
            authCloud: "Cloud (Email + Token API)",
            authServer: "Server/DC (Token de acesso pessoal)",
            emailLabel: "Email (apenas Cloud)",
            apiTokenLabel: "Token API / Token de acesso pessoal",
            projectKeyLabel: "Chave do projeto (opcional)",
            projectKeyPlaceholder: "Deixe vazio para importar de todos os projetos",
            domainTokenRequired: "DomÃ­nio e token API sÃ£o obrigatÃ³rios",
            emailRequired: "Email Ã© obrigatÃ³rio para autenticaÃ§Ã£o Cloud",
            credentialsFoundTitle: "Credenciais JIRA encontradas",
            credentialsFoundMsg: "Credenciais armazenadas para:\nDomÃ­nio: {domain}\nEmail: {email}\n\nO que deseja fazer?",
            useStored: "Usar credenciais armazenadas",
            clearReenter: "Limpar e reinserir",
            reenterDomainLabel: "DomÃ­nio JIRA",
            reenterEmailLabel: "Email JIRA",
            reenterTokenLabel: "Token API JIRA",
            allFieldsRequired: "DomÃ­nio, email e token API sÃ£o obrigatÃ³rios",
            importingTitle: "Importando issues JIRA",
            importingMsg: "Buscando issues do JIRA...",
            noIssuesTitle: "Nenhum issue encontrado",
            noIssuesMsg: "Nenhum issue JIRA aberto encontrado correspondente aos critÃ©rios.",
            summaryTitle: "ImportaÃ§Ã£o JIRA",
            summaryComplete: "ImportaÃ§Ã£o JIRA concluÃ­da",
            summaryTotal: "Total de issues encontrados",
            summaryCreated: "Novas tarefas criadas",
            summarySkipped: "Ignorados (jÃ¡ importados)",
            summaryLocation: 'As tarefas foram adicionadas ao projeto "JIRA Issues" na pasta "JIRA".',
            errorTitle: "Erro",
            noteIssue: "ISSUE JIRA",
            noteLink: "Link",
            noteStatus: "Status",
            noteType: "Tipo",
            notePriority: "Prioridade",
            noteAssignee: "ResponsÃ¡vel",
            noteReporter: "Reportado por",
            noteLabels: "RÃ³tulos",
            noteComponents: "Componentes",
            noteCreated: "Criado",
            noteUpdated: "Atualizado",
            noteDescription: "DESCRIÃ‡ÃƒO"
        },
        ja: {
            continueButton: "ç¶šè¡Œ",
            cancelButton: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
            credentialsPrompt: "JIRAèªè¨¼æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆå®‰å…¨ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼‰",
            domainLabel: "JIRAãƒ‰ãƒ¡ã‚¤ãƒ³/URL",
            domainPlaceholder: "your-company.atlassian.net ã¾ãŸã¯ https://jira.yourcompany.com",
            authTypeLabel: "èªè¨¼ã‚¿ã‚¤ãƒ—",
            authCloud: "Cloudï¼ˆãƒ¡ãƒ¼ãƒ« + APIãƒˆãƒ¼ã‚¯ãƒ³ï¼‰",
            authServer: "Server/DCï¼ˆå€‹äººã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰",
            emailLabel: "ãƒ¡ãƒ¼ãƒ«ï¼ˆCloudã®ã¿ï¼‰",
            apiTokenLabel: "APIãƒˆãƒ¼ã‚¯ãƒ³ / å€‹äººã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³",
            projectKeyLabel: "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚­ãƒ¼ï¼ˆä»»æ„ï¼‰",
            projectKeyPlaceholder: "ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã«ã¯ç©ºæ¬„ã®ã¾ã¾ã«ã—ã¦ãã ã•ã„",
            domainTokenRequired: "ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨APIãƒˆãƒ¼ã‚¯ãƒ³ã¯å¿…é ˆã§ã™",
            emailRequired: "Cloudèªè¨¼ã«ã¯ãƒ¡ãƒ¼ãƒ«ãŒå¿…è¦ã§ã™",
            credentialsFoundTitle: "JIRAèªè¨¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ",
            credentialsFoundMsg: "ä¿å­˜ã•ã‚ŒãŸèªè¨¼æƒ…å ±:\nãƒ‰ãƒ¡ã‚¤ãƒ³: {domain}\nãƒ¡ãƒ¼ãƒ«: {email}\n\nã©ã†ã—ã¾ã™ã‹ï¼Ÿ",
            useStored: "ä¿å­˜ã•ã‚ŒãŸèªè¨¼æƒ…å ±ã‚’ä½¿ç”¨",
            clearReenter: "å‰Šé™¤ã—ã¦å†å…¥åŠ›",
            reenterDomainLabel: "JIRAãƒ‰ãƒ¡ã‚¤ãƒ³",
            reenterEmailLabel: "JIRAãƒ¡ãƒ¼ãƒ«",
            reenterTokenLabel: "JIRA APIãƒˆãƒ¼ã‚¯ãƒ³",
            allFieldsRequired: "ãƒ‰ãƒ¡ã‚¤ãƒ³ã€ãƒ¡ãƒ¼ãƒ«ã€APIãƒˆãƒ¼ã‚¯ãƒ³ã¯å¿…é ˆã§ã™",
            importingTitle: "JIRAãƒã‚±ãƒƒãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­",
            importingMsg: "JIRAã‹ã‚‰ãƒã‚±ãƒƒãƒˆã‚’å–å¾—ä¸­...",
            noIssuesTitle: "ãƒã‚±ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“",
            noIssuesMsg: "æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ã‚ªãƒ¼ãƒ—ãƒ³ãªJIRAãƒã‚±ãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",
            summaryTitle: "JIRAã‚¤ãƒ³ãƒãƒ¼ãƒˆ",
            summaryComplete: "JIRAã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†",
            summaryTotal: "è¦‹ã¤ã‹ã£ãŸãƒã‚±ãƒƒãƒˆåˆè¨ˆ",
            summaryCreated: "æ–°è¦ã‚¿ã‚¹ã‚¯ä½œæˆ",
            summarySkipped: "ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆæ¸ˆã¿ï¼‰",
            summaryLocation: 'ã‚¿ã‚¹ã‚¯ã¯ã€ŒJIRAã€ãƒ•ã‚©ãƒ«ãƒ€ã®ã€ŒJIRA Issuesã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚',
            errorTitle: "ã‚¨ãƒ©ãƒ¼",
            noteIssue: "JIRAãƒã‚±ãƒƒãƒˆ",
            noteLink: "ãƒªãƒ³ã‚¯",
            noteStatus: "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹",
            noteType: "ã‚¿ã‚¤ãƒ—",
            notePriority: "å„ªå…ˆåº¦",
            noteAssignee: "æ‹…å½“è€…",
            noteReporter: "å ±å‘Šè€…",
            noteLabels: "ãƒ©ãƒ™ãƒ«",
            noteComponents: "ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ",
            noteCreated: "ä½œæˆæ—¥",
            noteUpdated: "æ›´æ–°æ—¥",
            noteDescription: "èª¬æ˜"
        },
        zh: {
            continueButton: "ç»§ç»­",
            cancelButton: "å–æ¶ˆ",
            credentialsPrompt: "è¾“å…¥æ‚¨çš„ JIRA å‡­æ®ï¼ˆå°†å®‰å…¨å­˜å‚¨ï¼‰",
            domainLabel: "JIRA åŸŸå/URL",
            domainPlaceholder: "your-company.atlassian.net æˆ– https://jira.yourcompany.com",
            authTypeLabel: "è®¤è¯ç±»å‹",
            authCloud: "Cloudï¼ˆé‚®ç®± + API ä»¤ç‰Œï¼‰",
            authServer: "Server/DCï¼ˆä¸ªäººè®¿é—®ä»¤ç‰Œï¼‰",
            emailLabel: "é‚®ç®±ï¼ˆä»… Cloudï¼‰",
            apiTokenLabel: "API ä»¤ç‰Œ / ä¸ªäººè®¿é—®ä»¤ç‰Œ",
            projectKeyLabel: "é¡¹ç›®é”®ï¼ˆå¯é€‰ï¼‰",
            projectKeyPlaceholder: "ç•™ç©ºä»¥ä»æ‰€æœ‰é¡¹ç›®å¯¼å…¥",
            domainTokenRequired: "åŸŸåå’Œ API ä»¤ç‰Œæ˜¯å¿…å¡«é¡¹",
            emailRequired: "Cloud è®¤è¯éœ€è¦é‚®ç®±",
            credentialsFoundTitle: "å·²æ‰¾åˆ° JIRA å‡­æ®",
            credentialsFoundMsg: "å·²å­˜å‚¨çš„å‡­æ®ï¼š\nåŸŸåï¼š{domain}\né‚®ç®±ï¼š{email}\n\næ‚¨æƒ³æ€ä¹ˆåšï¼Ÿ",
            useStored: "ä½¿ç”¨å·²å­˜å‚¨çš„å‡­æ®",
            clearReenter: "æ¸…é™¤å¹¶é‡æ–°è¾“å…¥",
            reenterDomainLabel: "JIRA åŸŸå",
            reenterEmailLabel: "JIRA é‚®ç®±",
            reenterTokenLabel: "JIRA API ä»¤ç‰Œ",
            allFieldsRequired: "åŸŸåã€é‚®ç®±å’Œ API ä»¤ç‰Œæ˜¯å¿…å¡«é¡¹",
            importingTitle: "æ­£åœ¨å¯¼å…¥ JIRA é—®é¢˜",
            importingMsg: "æ­£åœ¨ä» JIRA è·å–é—®é¢˜...",
            noIssuesTitle: "æœªæ‰¾åˆ°é—®é¢˜",
            noIssuesMsg: "æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å¼€æ”¾ JIRA é—®é¢˜ã€‚",
            summaryTitle: "JIRA å¯¼å…¥",
            summaryComplete: "JIRA å¯¼å…¥å®Œæˆ",
            summaryTotal: "æ‰¾åˆ°çš„é—®é¢˜æ€»æ•°",
            summaryCreated: "æ–°åˆ›å»ºçš„ä»»åŠ¡",
            summarySkipped: "å·²è·³è¿‡ï¼ˆå·²å¯¼å…¥ï¼‰",
            summaryLocation: 'ä»»åŠ¡å·²æ·»åŠ åˆ° "JIRA" æ–‡ä»¶å¤¹ä¸­çš„ "JIRA Issues" é¡¹ç›®ã€‚',
            errorTitle: "é”™è¯¯",
            noteIssue: "JIRA é—®é¢˜",
            noteLink: "é“¾æ¥",
            noteStatus: "çŠ¶æ€",
            noteType: "ç±»å‹",
            notePriority: "ä¼˜å…ˆçº§",
            noteAssignee: "ç»åŠäºº",
            noteReporter: "æŠ¥å‘Šäºº",
            noteLabels: "æ ‡ç­¾",
            noteComponents: "ç»„ä»¶",
            noteCreated: "åˆ›å»ºæ—¥æœŸ",
            noteUpdated: "æ›´æ–°æ—¥æœŸ",
            noteDescription: "æè¿°"
        },
        nl: {
            continueButton: "Doorgaan",
            cancelButton: "Annuleren",
            credentialsPrompt: "Voer je JIRA-inloggegevens in (worden veilig opgeslagen)",
            domainLabel: "JIRA-domein/URL",
            domainPlaceholder: "je-bedrijf.atlassian.net of https://jira.jebedrijf.com",
            authTypeLabel: "Authenticatietype",
            authCloud: "Cloud (E-mail + API-token)",
            authServer: "Server/DC (Persoonlijk toegangstoken)",
            emailLabel: "E-mail (alleen Cloud)",
            apiTokenLabel: "API-token / Persoonlijk toegangstoken",
            projectKeyLabel: "Projectsleutel (optioneel)",
            projectKeyPlaceholder: "Laat leeg om uit alle projecten te importeren",
            domainTokenRequired: "Domein en API-token zijn vereist",
            emailRequired: "E-mail is vereist voor Cloud-authenticatie",
            credentialsFoundTitle: "JIRA-inloggegevens gevonden",
            credentialsFoundMsg: "Opgeslagen inloggegevens voor:\nDomein: {domain}\nE-mail: {email}\n\nWat wil je doen?",
            useStored: "Opgeslagen inloggegevens gebruiken",
            clearReenter: "Wissen en opnieuw invoeren",
            reenterDomainLabel: "JIRA-domein",
            reenterEmailLabel: "JIRA-e-mail",
            reenterTokenLabel: "JIRA API-token",
            allFieldsRequired: "Domein, e-mail en API-token zijn vereist",
            importingTitle: "JIRA-issues importeren",
            importingMsg: "Issues ophalen uit JIRA...",
            noIssuesTitle: "Geen issues gevonden",
            noIssuesMsg: "Geen open JIRA-issues gevonden die aan de criteria voldoen.",
            summaryTitle: "JIRA-import",
            summaryComplete: "JIRA-import voltooid",
            summaryTotal: "Totaal gevonden issues",
            summaryCreated: "Nieuwe taken aangemaakt",
            summarySkipped: "Overgeslagen (al geÃ¯mporteerd)",
            summaryLocation: 'Taken zijn toegevoegd aan het project "JIRA Issues" in de map "JIRA".',
            errorTitle: "Fout",
            noteIssue: "JIRA-ISSUE",
            noteLink: "Link",
            noteStatus: "Status",
            noteType: "Type",
            notePriority: "Prioriteit",
            noteAssignee: "Toegewezen aan",
            noteReporter: "Gemeld door",
            noteLabels: "Labels",
            noteComponents: "Componenten",
            noteCreated: "Aangemaakt",
            noteUpdated: "Bijgewerkt",
            noteDescription: "BESCHRIJVING"
        }
    };

    function getSystemLanguage() {
        try {
            const locale = Intl.DateTimeFormat().resolvedOptions().locale;
            return locale ? locale.split("-")[0].toLowerCase() : "en";
        } catch (e) {
            return "en";
        }
    }

    function getEffectiveLanguage() {
        const prefs = new Preferences("com.omnifocus.headless-settings");
        const override = prefs.readString("language");
        if (override && override !== "auto") {
            return STRINGS[override] ? override : "en";
        }
        const detected = getSystemLanguage();
        return STRINGS[detected] ? detected : "en";
    }

    function t(key, replacements) {
        const lang = getEffectiveLanguage();
        let str = (STRINGS[lang] && STRINGS[lang][key]) || STRINGS.en[key] || key;
        if (replacements) {
            for (const [k, v] of Object.entries(replacements)) {
                str = str.replace(`{${k}}`, v);
            }
        }
        return str;
    }

    const action = new PlugIn.Action(async function(selection, sender) {
        try {
            console.log("=== JIRA Import Debug Log ===");
            console.log("Starting plugin execution...");

            // Headless mode: skip all dialogs, use stored credentials and defaults
            const prefs = new Preferences("com.omnifocus.jira-import");
            const headless = prefs.readBoolean("headlessMode");
            console.log("Headless mode:", headless);

            // Get JIRA credentials
            let jiraConfig = null;
            const storedCreds = credentials.read("jira");
            console.log("Credentials check:", storedCreds ? "Found stored credentials" : "No stored credentials");

            if (!storedCreds) {
                // No stored credentials - always prompt (even in headless mode, credentials must be entered at least once)
                console.log("No credentials found, prompting user (required for first run)...");
                const form = new Form();

                const domainField = new Form.Field.String(
                    "domain",
                    t("domainLabel"),
                    t("domainPlaceholder")
                );

                const authTypeField = new Form.Field.Option(
                    "authType",
                    t("authTypeLabel"),
                    ["cloud", "server"],
                    [t("authCloud"), t("authServer")],
                    0
                );

                const emailField = new Form.Field.String(
                    "email",
                    t("emailLabel"),
                    null
                );

                const apiTokenField = new Form.Field.Password(
                    "apiToken",
                    t("apiTokenLabel"),
                    null
                );

                const projectKeyField = new Form.Field.String(
                    "projectKey",
                    t("projectKeyLabel"),
                    t("projectKeyPlaceholder")
                );

                form.addField(domainField);
                form.addField(authTypeField);
                form.addField(emailField);
                form.addField(apiTokenField);
                form.addField(projectKeyField);

                const formPrompt = await form.show(
                    t("credentialsPrompt"),
                    t("continueButton")
                );

                jiraConfig = {
                    domain: formPrompt.values.domain,
                    authType: formPrompt.values.authType,
                    email: formPrompt.values.email,
                    apiToken: formPrompt.values.apiToken,
                    projectKey: formPrompt.values.projectKey || ""
                };

                console.log("User entered config:", {
                    domain: jiraConfig.domain,
                    authType: jiraConfig.authType,
                    email: jiraConfig.email || "(not used for server auth)",
                    apiToken: "[REDACTED]",
                    projectKey: jiraConfig.projectKey || "(none)"
                });

                // Validate based on auth type
                if (!jiraConfig.domain || !jiraConfig.apiToken) {
                    throw new Error(t("domainTokenRequired"));
                }
                if (jiraConfig.authType === "cloud" && !jiraConfig.email) {
                    throw new Error(t("emailRequired"));
                }

                console.log("Storing credentials in Keychain...");
                // Store credentials
                credentials.write("jira", jiraConfig.email, jiraConfig.apiToken);

                // Store domain and project key separately (not sensitive)
                const settings = {
                    domain: jiraConfig.domain,
                    projectKey: jiraConfig.projectKey
                };
                credentials.write("jira-settings", "config", JSON.stringify(settings));
                console.log("Credentials stored successfully");

            } else if (headless) {
                // Headless mode with stored credentials - use silently
                console.log("Headless: loading stored credentials...");
                const settingsData = credentials.read("jira-settings");
                const settings = settingsData ? JSON.parse(settingsData.password) : {};

                jiraConfig = {
                    domain: settings.domain,
                    email: storedCreds.user,
                    apiToken: storedCreds.password,
                    projectKey: settings.projectKey || ""
                };

                console.log("Headless: loaded config:", {
                    domain: jiraConfig.domain,
                    email: jiraConfig.email,
                    apiToken: "[REDACTED]",
                    projectKey: jiraConfig.projectKey || "(none)"
                });
            } else {
                // Interactive mode - offer to use or clear them
                const settingsData = credentials.read("jira-settings");
                const settings = settingsData ? JSON.parse(settingsData.password) : {};

                const alert = new Alert(
                    t("credentialsFoundTitle"),
                    t("credentialsFoundMsg", {domain: settings.domain || 'Unknown', email: storedCreds.user})
                );
                alert.addOption(t("useStored"));
                alert.addOption(t("clearReenter"));
                alert.addOption(t("cancelButton"));

                const choice = await alert.show();

                if (choice === 0) {
                    // Use stored credentials
                    console.log("Loading stored credentials...");

                    jiraConfig = {
                        domain: settings.domain,
                        email: storedCreds.user,
                        apiToken: storedCreds.password,
                        projectKey: settings.projectKey || ""
                    };

                    console.log("Loaded config:", {
                        domain: jiraConfig.domain,
                        email: jiraConfig.email,
                        apiToken: "[REDACTED]",
                        projectKey: jiraConfig.projectKey || "(none)"
                    });
                } else if (choice === 1) {
                    // Clear and re-enter
                    console.log("Clearing stored credentials...");
                    credentials.remove("jira");
                    credentials.remove("jira-settings");
                    console.log("Credentials cleared");

                    // Prompt for new credentials
                    const form = new Form();

                    const domainField = new Form.Field.String(
                        "domain",
                        t("reenterDomainLabel"),
                        settings.domain || "your-company.atlassian.net"
                    );

                    const emailField = new Form.Field.String(
                        "email",
                        t("reenterEmailLabel"),
                        storedCreds.user || null
                    );

                    const apiTokenField = new Form.Field.Password(
                        "apiToken",
                        t("reenterTokenLabel"),
                        null
                    );

                    const projectKeyField = new Form.Field.String(
                        "projectKey",
                        t("projectKeyLabel"),
                        settings.projectKey || t("projectKeyPlaceholder")
                    );

                    form.addField(domainField);
                    form.addField(emailField);
                    form.addField(apiTokenField);
                    form.addField(projectKeyField);

                    const formPrompt = await form.show(
                        t("credentialsPrompt"),
                        t("continueButton")
                    );

                    jiraConfig = {
                        domain: formPrompt.values.domain,
                        email: formPrompt.values.email,
                        apiToken: formPrompt.values.apiToken,
                        projectKey: formPrompt.values.projectKey || ""
                    };

                    console.log("User entered config:", {
                        domain: jiraConfig.domain,
                        email: jiraConfig.email,
                        apiToken: "[REDACTED]",
                        projectKey: jiraConfig.projectKey || "(none)"
                    });

                    if (!jiraConfig.domain || !jiraConfig.email || !jiraConfig.apiToken) {
                        throw new Error(t("allFieldsRequired"));
                    }

                    console.log("Storing new credentials in Keychain...");
                    credentials.write("jira", jiraConfig.email, jiraConfig.apiToken);

                    const newSettings = {
                        domain: jiraConfig.domain,
                        projectKey: jiraConfig.projectKey
                    };
                    credentials.write("jira-settings", "config", JSON.stringify(newSettings));
                    console.log("Credentials stored successfully");
                } else {
                    // Cancel
                    console.log("User cancelled");
                    return;
                }
            }

            // Build JQL query for open issues assigned to current user
            let jql = 'assignee = currentUser() AND resolution = Unresolved ORDER BY created DESC';
            if (jiraConfig.projectKey) {
                jql = `project = ${jiraConfig.projectKey} AND ${jql}`;
            }
            console.log("JQL Query:", jql);

            // Fetch issues from JIRA
            console.log("Preparing JIRA API request...");
            const request = new URL.FetchRequest();
            // Use API v2 for Server/DC compatibility (v3 is Cloud-only)
            const searchUrl = `https://${jiraConfig.domain}/rest/api/2/search`;
            request.url = URL.fromString(searchUrl);
            request.method = "POST";

            // Create authentication header based on type
            let authHeader;
            if (jiraConfig.authType === "cloud") {
                // Cloud: Basic Auth with email:token
                const authString = `${jiraConfig.email}:${jiraConfig.apiToken}`;
                const authBase64 = Data.fromString(authString, null).toBase64();
                authHeader = `Basic ${authBase64}`;
                console.log("Using Cloud authentication (Basic Auth)");
            } else {
                // Server/DC: Bearer token with Personal Access Token
                authHeader = `Bearer ${jiraConfig.apiToken}`;
                console.log("Using Server/DC authentication (Bearer Token)");
            }

            request.headers = {
                "Authorization": authHeader,
                "Content-Type": "application/json",
                "Accept": "application/json"
            };

            const requestBody = {
                jql: jql,
                maxResults: 100,
                fields: [
                    "summary",
                    "description",
                    "status",
                    "priority",
                    "issuetype",
                    "assignee",
                    "reporter",
                    "created",
                    "updated",
                    "duedate",
                    "labels",
                    "components"
                ]
            };

            request.bodyString = JSON.stringify(requestBody);

            console.log("=== JIRA API Request ===");
            console.log("URL:", searchUrl);
            console.log("Method:", request.method);
            console.log("Auth Type:", jiraConfig.authType);
            console.log("Headers:", JSON.stringify({
                "Authorization": jiraConfig.authType === "cloud" ? "Basic [REDACTED]" : "Bearer [REDACTED]",
                "Content-Type": "application/json",
                "Accept": "application/json"
            }, null, 2));
            console.log("Request Body:", JSON.stringify(requestBody, null, 2));

            // Show progress
            if (!headless) {
                const progress = new Alert(t("importingTitle"), t("importingMsg"));
                progress.show(() => {});
            }

            console.log("Sending request to JIRA...");
            const response = await request.fetch();

            console.log("=== JIRA API Response ===");
            console.log("Status Code:", response.statusCode);
            console.log("Response Body:", response.bodyString);

            if (response.statusCode !== 200) {
                console.error("JIRA API Error - Status:", response.statusCode);
                console.error("JIRA API Error - Body:", response.bodyString);
                throw new Error(`JIRA API Error: ${response.statusCode} - ${response.bodyString}`);
            }

            const data = JSON.parse(response.bodyString);
            console.log("Parsed response data - Total issues:", data.total);
            console.log("Issues returned:", data.issues ? data.issues.length : 0);

            const issues = data.issues || [];

            if (issues.length === 0) {
                console.log("No issues found");
                if (!headless) {
                    new Alert(t("noIssuesTitle"), t("noIssuesMsg")).show();
                }
                return;
            }

            console.log(`Found ${issues.length} issues to import`);

            // Create or get JIRA project/folder
            console.log("Setting up JIRA folder and project...");
            let jiraFolder = library.byName("JIRA");
            if (!jiraFolder) {
                jiraFolder = new Folder("JIRA", library.ending);
                console.log("Created JIRA folder");
            } else {
                console.log("Found existing JIRA folder");
            }

            // Create or get JIRA project
            let jiraProject = jiraFolder.projectNamed("JIRA Issues");
            if (!jiraProject) {
                jiraProject = new Project("JIRA Issues", jiraFolder.ending);
                console.log("Created JIRA Issues project");
            } else {
                console.log("Found existing JIRA Issues project");
            }

            // Create base JIRA tag
            console.log("Setting up JIRA tag...");
            let jiraTag = tags.byName("JIRA");
            if (!jiraTag) {
                jiraTag = new Tag("JIRA", tags.ending);
                console.log("Created JIRA tag");
            } else {
                console.log("Found existing JIRA tag");
            }

            // Process each issue
            console.log("Processing issues...");
            let importedCount = 0;
            let skippedCount = 0;

            for (const issue of issues) {
                const fields = issue.fields;
                const issueKey = issue.key;

                console.log(`\nProcessing issue: ${issueKey}`);
                console.log("Issue data:", JSON.stringify({
                    key: issueKey,
                    summary: fields.summary,
                    status: fields.status?.name,
                    type: fields.issuetype?.name,
                    priority: fields.priority?.name
                }, null, 2));

                // Check if task already exists (by searching for JIRA key in notes)
                const existingTask = flattenedTasks.find(task =>
                    task.note && task.note.includes(`JIRA: ${issueKey}`)
                );

                if (existingTask) {
                    console.log(`Skipping ${issueKey} - already exists`);
                    skippedCount++;
                    continue;
                }

                console.log(`Creating new task for ${issueKey}`);

                // Create task
                const taskName = `[${issueKey}] ${fields.summary}`;
                const task = new Task(taskName, jiraProject.task.ending);

                // Build task note with JIRA details and clickable link
                let noteContent = `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                noteContent += `ğŸ”— ${t("noteIssue")}: ${issueKey}\n`;
                noteContent += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
                noteContent += `ğŸŒ ${t("noteLink")}: https://${jiraConfig.domain}/browse/${issueKey}\n\n`;
                noteContent += `ğŸ“Š ${t("noteStatus")}: ${fields.status.name}\n`;
                noteContent += `ğŸ“ ${t("noteType")}: ${fields.issuetype.name}\n`;
                noteContent += `âš¡ ${t("notePriority")}: ${fields.priority ? fields.priority.name : 'None'}\n`;

                if (fields.assignee) {
                    noteContent += `ğŸ‘¤ ${t("noteAssignee")}: ${fields.assignee.displayName}\n`;
                }

                if (fields.reporter) {
                    noteContent += `ğŸ“¢ ${t("noteReporter")}: ${fields.reporter.displayName}\n`;
                }

                if (fields.labels && fields.labels.length > 0) {
                    noteContent += `ğŸ·ï¸  ${t("noteLabels")}: ${fields.labels.join(', ')}\n`;
                }

                if (fields.components && fields.components.length > 0) {
                    const componentNames = fields.components.map(c => c.name).join(', ');
                    noteContent += `ğŸ”§ ${t("noteComponents")}: ${componentNames}\n`;
                }

                noteContent += `ğŸ“… ${t("noteCreated")}: ${new Date(fields.created).toLocaleDateString()}\n`;
                noteContent += `ğŸ”„ ${t("noteUpdated")}: ${new Date(fields.updated).toLocaleDateString()}\n`;

                if (fields.description) {
                    noteContent += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                    noteContent += `ğŸ“„ ${t("noteDescription")}\n`;
                    noteContent += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
                    noteContent += fields.description;
                }

                task.note = noteContent;

                // Set due date if available
                if (fields.duedate) {
                    task.dueDate = new Date(fields.duedate);
                    console.log(`Set due date: ${fields.duedate}`);
                }

                // Add only the JIRA tag (all other info is in notes)
                task.addTag(jiraTag);
                console.log("Added JIRA tag");

                importedCount++;
                console.log(`Successfully created task for ${issueKey}`);
            }

            // Show summary
            const summary = `${t("summaryComplete")}!\n\n` +
                `${t("summaryTotal")}: ${issues.length}\n` +
                `${t("summaryCreated")}: ${importedCount}\n` +
                `${t("summarySkipped")}: ${skippedCount}\n\n` +
                t("summaryLocation");

            console.log("=== Import Summary ===");
            console.log(summary);
            console.log("=== End Debug Log ===");

            if (!headless) {
                new Alert(t("summaryTitle"), summary).show();
            }

        } catch (error) {
            console.error("=== ERROR ===");
            console.error("Error message:", error.message);
            console.error("Error stack:", error.stack);
            console.error("=== End Debug Log ===");
            if (!headless) {
                new Alert(t("errorTitle"), error.message).show();
            }
        }
    });

    action.validate = function(selection, sender) {
        return true; // Always available
    };

    return action;
})();
